name: ZeroKeyCI Reusable Deployment Workflow

on:
  workflow_call:
    inputs:
      safe-address:
        description: 'Gnosis Safe multisig address'
        required: true
        type: string

      network:
        description: 'Network to deploy to'
        required: true
        type: string
        default: 'sepolia'

      contract-name:
        description: 'Contract name to deploy'
        required: true
        type: string

      deploy-config-path:
        description: 'Path to deployment configuration'
        required: false
        type: string
        default: '.zerokey/deploy.yaml'

      policy-path:
        description: 'Path to OPA policy file'
        required: false
        type: string
        default: '.zerokey/policy.rego'

      verify-blockscout:
        description: 'Verify on Blockscout'
        required: false
        type: boolean
        default: true

      enable-envio:
        description: 'Enable Envio indexing'
        required: false
        type: boolean
        default: false

    secrets:
      rpc-url:
        description: 'RPC URL for network access'
        required: true

      blockscout-api-url:
        description: 'Blockscout API URL'
        required: false

    outputs:
      proposal-hash:
        description: 'Safe proposal hash'
        value: ${{ jobs.create-safe-proposal.outputs.proposal-hash }}

      safe-address:
        description: 'Safe address'
        value: ${{ jobs.create-safe-proposal.outputs.safe-address }}

      chain-id:
        description: 'Chain ID'
        value: ${{ jobs.create-safe-proposal.outputs.chain-id }}

      explorer-url:
        description: 'Explorer URL'
        value: ${{ jobs.create-safe-proposal.outputs.explorer-url }}

jobs:
  create-safe-proposal:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      pull-requests: write
      actions: write

    outputs:
      proposal-hash: ${{ steps.deploy.outputs.proposal-hash }}
      safe-address: ${{ steps.deploy.outputs.safe-address }}
      chain-id: ${{ steps.deploy.outputs.chain-id }}
      explorer-url: ${{ steps.deploy.outputs.explorer-url }}

    steps:
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout ZeroKeyCI
        uses: actions/checkout@v4
        with:
          repository: susumutomita/ZeroKeyCI
          path: .zerokeyci
          ref: main

      - name: Setup environment
        run: |
          echo "ðŸš€ ZeroKeyCI Keyless Deployment"
          echo "================================"
          echo "Safe Address: ${{ inputs.safe-address }}"
          echo "Network: ${{ inputs.network }}"
          echo "Contract: ${{ inputs.contract-name }}"

      - name: Run ZeroKeyCI Action
        id: deploy
        uses: ./.zerokeyci
        with:
          safe-address: ${{ inputs.safe-address }}
          network: ${{ inputs.network }}
          contract-name: ${{ inputs.contract-name }}
          rpc-url: ${{ secrets.rpc-url }}
          deploy-config-path: ${{ inputs.deploy-config-path }}
          policy-path: ${{ inputs.policy-path }}
          verify-blockscout: ${{ inputs.verify-blockscout }}
          blockscout-api-url: ${{ secrets.blockscout-api-url || 'https://eth-sepolia.blockscout.com/api' }}
          enable-envio: ${{ inputs.enable-envio }}

      - name: Comment on PR with proposal details
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const proposalHash = '${{ steps.deploy.outputs.proposal-hash }}';
            const safeAddress = '${{ inputs.safe-address }}';
            const network = '${{ inputs.network }}';
            const contract = '${{ inputs.contract-name }}';

            const comment = `## ðŸš€ ZeroKeyCI Deployment Proposal

            A keyless Safe transaction proposal has been generated.

            ### ðŸ“‹ Deployment Details
            - **Contract**: \`${contract}\`
            - **Network**: \`${network}\`
            - **Safe Address**: \`${safeAddress}\`
            - **Proposal Hash**: \`${proposalHash}\`

            ### ðŸ” Next Steps
            1. Safe owners review and sign the proposal
            2. Once threshold is reached, execute the transaction
            3. Contract will be deployed without any private keys in CI/CD

            ### ðŸ“¦ Artifacts
            - [Download Proposal](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *Powered by [ZeroKeyCI](https://github.com/susumutomita/ZeroKeyCI) - Keyless Smart Contract Deployment*`;

            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

      - name: Summary
        run: |
          echo "## âœ… ZeroKeyCI Deployment Proposal Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Safe Address**: \`${{ inputs.safe-address }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Network**: \`${{ inputs.network }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Contract**: \`${{ inputs.contract-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Proposal Hash**: \`${{ steps.deploy.outputs.proposal-hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Security" >> $GITHUB_STEP_SUMMARY
          echo "No private keys were used or stored in this workflow." >> $GITHUB_STEP_SUMMARY
          echo "Safe owners must sign and execute the proposal separately." >> $GITHUB_STEP_SUMMARY
