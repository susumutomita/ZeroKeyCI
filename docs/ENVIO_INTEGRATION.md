# Envio HyperIndex Integration

Complete guide for using Envio HyperIndex with ZeroKeyCI to index and query Gnosis Safe deployment events in real-time.

## Overview

Envio HyperIndex provides **real-time indexing** of ZeroKeyCI deployment events:
- Safe proposal creation
- Owner approvals
- Transaction execution (success/failure)
- Deployment metrics and analytics

## Quick Start

### 1. Deploy Envio Indexer

```bash
# Install Envio CLI
npm install -g envio

# Deploy indexer
envio deploy \
  --config .zerokey/envio-config.yaml \
  --schema .zerokey/envio-schema.graphql
```

### 2. Query Deployment Data

```graphql
query ZeroKeyDeployments {
  zeroKeyDeployments(
    where: { safe: "0xYourSafeAddress" }
    orderBy: proposalDate
    orderDirection: desc
  ) {
    contractName
    prNumber
    commitHash
    status
    executionDate
    blockscoutUrl
  }
}
```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Gnosis Safe Contract                      │
│                                                              │
│  Events:                                                     │
│    - SafeMultiSigTransaction (proposal created)             │
│    - ApproveHash (owner approval)                           │
│    - ExecutionSuccess (deployment succeeded)                │
│    - ExecutionFailure (deployment failed)                   │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                   Envio HyperSync                           │
│                                                              │
│  Real-time blockchain event streaming                        │
│  - Low latency (< 1s)                                       │
│  - Historical data                                           │
│  - Automatic reorg handling                                  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                  Event Handlers                              │
│                (src/envio/EventHandlers.ts)                  │
│                                                              │
│  Process and transform events:                               │
│    - Extract PR number, commit hash                          │
│    - Calculate time to execution                             │
│    - Track owner activity                                    │
│    - Generate deployment metrics                             │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                  PostgreSQL Database                         │
│                                                              │
│  Entities:                                                   │
│    - SafeTransaction                                         │
│    - ZeroKeyDeployment                                       │
│    - SafeConfirmation                                        │
│    - ExecutionSuccess/Failure                                │
│    - SafeStats, OwnerActivity                                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    GraphQL API                               │
│              (Auto-generated by Envio)                       │
│                                                              │
│  Query examples:                                             │
│    - Get all deployments                                     │
│    - Track pending proposals                                 │
│    - Monitor owner activity                                  │
│    - Calculate deployment metrics                            │
└─────────────────────────────────────────────────────────────┘
```

## Configuration

### Envio Config (`.zerokey/envio-config.yaml`)

```yaml
name: zerokeyci-safe-indexer
description: Indexes Gnosis Safe multisig proposals for ZeroKeyCI

networks:
  - id: 11155111  # Sepolia testnet
    name: sepolia
    rpc_config:
      url: ${SEPOLIA_RPC_URL}
    hypersync:
      enabled: true
      url: https://sepolia.hypersync.xyz

contracts:
  - name: GnosisSafe
    abi_file_path: ./abis/GnosisSafe.json
    address:
      - ${SAFE_ADDRESS}
    handler: src/envio/EventHandlers.ts
    events:
      - event: "SafeMultiSigTransaction(...)"
      - event: "ExecutionSuccess(bytes32,uint256)"
      - event: "ExecutionFailure(bytes32,uint256)"
      - event: "ApproveHash(bytes32,address)"
```

### GraphQL Schema (`.zerokey/envio-schema.graphql`)

Key entities:

```graphql
type SafeTransaction @entity {
  id: ID!
  safe: String!
  to: String!
  value: BigInt!
  data: Bytes!
  isExecuted: Boolean!
  prNumber: String      # ZeroKeyCI metadata
  commitHash: String    # Git commit hash
  contractName: String  # Contract being deployed
}

type ZeroKeyDeployment @entity {
  id: ID!
  safe: String!
  contractName: String!
  prNumber: String!
  commitHash: String!
  proposalDate: BigInt!
  executionDate: BigInt
  status: String!  # pending | executed | failed
  timeToExecution: BigInt
  blockscoutUrl: String
}

type SafeStats @entity {
  id: ID!  # Safe address
  totalProposals: BigInt!
  executedProposals: BigInt!
  failedProposals: BigInt!
  totalDeployments: BigInt!
  totalUpgrades: BigInt!
}
```

## Query Examples

### 1. Get All Pending Proposals

```graphql
query PendingProposals {
  safeTransactions(
    where: {
      safe: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
      isExecuted: false
    }
    orderBy: submissionDate
  ) {
    id
    to
    contractName
    prNumber
    confirmations {
      owner
      submissionDate
    }
  }
}
```

### 2. Track Deployment Metrics

```graphql
query DeploymentMetrics {
  zeroKeyDeployments(
    where: { status: "executed" }
    orderBy: proposalDate
    orderDirection: desc
    first: 10
  ) {
    contractName
    prNumber
    proposalDate
    executionDate
    timeToFirstConfirmation
    timeToExecution
    gasUsed
  }
}
```

### 3. Monitor Owner アクティビティ

```graphql
query OwnerActivity {
  ownerActivities(
    where: { safe: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb" }
  ) {
    owner
    totalConfirmations
    lastConfirmation
    averageResponseTime
  }
}
```

### 4. Safe Dashboard (Complete Overview)

```graphql
query SafeDashboard {
  safeStats(id: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb") {
    totalProposals
    executedProposals
    pendingProposals
    totalDeployments
  }

  recentDeployments: zeroKeyDeployments(
    where: { safe: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb" }
    first: 5
  ) {
    contractName
    status
    blockscoutUrl
  }

  ownerActivities(
    where: { safe: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb" }
  ) {
    owner
    totalConfirmations
  }
}
```

## Event Handlers

Event handlers process blockchain events and populate the database.

### Example: SafeMultiSigTransaction Handler

```typescript
GnosisSafe_SafeMultiSigTransaction_handler(({ event, context }) => {
  const transaction: SafeTransactionEntity = {
    id: event.transactionHash,
    safe: event.srcAddress,
    to: event.params.to,
    value: event.params.value,
    data: event.params.data,
    isExecuted: false,
    submissionDate: event.block.timestamp,
    // Extract ZeroKeyCI metadata
    prNumber: extractPRNumber(event.params.data),
    commitHash: extractCommitHash(event.params.data),
    contractName: extractContractName(event.params.data),
  };

  context.SafeTransaction.set(transaction);

  // Create ZeroKeyDeployment entity
  if (isDeploymentTransaction(event.params.data)) {
    createZeroKeyDeployment(context, transaction, event);
  }
});
```

### Metadata Extraction

Event handlers extract ZeroKeyCI metadata from transaction data:

```typescript
function extractPRNumber(data: string): string | undefined {
  // Extract PR number embedded in transaction calldata
  const match = data.match(/PR#(\d+)/);
  return match ? match[1] : undefined;
}

function extractCommitHash(data: string): string | undefined {
  // Extract commit hash (40-character hex)
  const match = data.match(/commit:([a-f0-9]{40})/i);
  return match ? match[1] : undefined;
}
```

## Integration with GitHub Actions

Add Envio indexing to your deployment workflow:

```yaml
# .github/workflows/deploy.yml
- name: Deploy Envio Indexer
  if: inputs.enable-envio == 'true'
  run: |
    npm install -g envio

    # Deploy indexer with Safe address
    envio deploy \
      --config .zerokey/envio-config.yaml \
      --env SAFE_ADDRESS=${{ inputs.safe-address }} \
      --env SEPOLIA_RPC_URL=${{ secrets.rpc-url }}

- name: Query Deployment Status
  run: |
    # Query Envio for deployment status
    curl -X POST https://indexer.envio.dev/graphql \
      -H "Content-Type: application/json" \
      -d '{
        "query": "query { zeroKeyDeployments(where: {prNumber: \"${{ github.event.pull_request.number }}\"}) { status blockscoutUrl } }"
      }'
```

## Monitoring and Analytics

### Real-time Monitoring

```javascript
// Subscribe to new deployments
const subscription = gql`
  subscription OnNewDeployment {
    zeroKeyDeployments(where: { status: "pending" }) {
      contractName
      prNumber
      proposalDate
    }
  }
`;

client.subscribe({ query: subscription }).subscribe({
  next: (data) => {
    console.log('New deployment proposal:', data);
    // Send notification (Discord, Slack, etc.)
  },
});
```

### Analytics Dashboard

```javascript
// Calculate deployment success rate
const analytics = await client.query({
  query: gql`
    query Analytics {
      safeStats(id: "${SAFE_ADDRESS}") {
        totalProposals
        executedProposals
        failedProposals
      }
    }
  `,
});

const successRate =
  analytics.executedProposals / analytics.totalProposals * 100;
console.log(`Deployment success rate: ${successRate}%`);
```

## Troubleshooting

### Issue 1: Indexer not syncing

```bash
# Check indexer status
envio status

# Restart indexer
envio restart

# Check logs
envio logs --follow
```

### Issue 2: Missing events

```bash
# Verify contract address in config
cat .zerokey/envio-config.yaml | grep address

# Check start block
# Ensure start_block is before first deployment
```

### Issue 3: GraphQL query errors

```bash
# Introspect schema
curl -X POST https://indexer.envio.dev/graphql \
  -H "Content-Type: application/json" \
  -d '{"query": "{ __schema { types { name } } }"}'
```

## Performance

Envio HyperSync provides:
- **Latency**: < 1 second from event to query
- **Throughput**: 1000+ events/second
- **Historical data**: Full blockchain history
- **Reorg handling**: Automatic rollback

## Cost

Envio offers:
- **Free tier**: Up to 100,000 events/month
- **Pro tier**: $99/month for 1M events
- **Self-hosted**: Open-source, free

## Next Steps

1. ✅ [Deploy Envio indexer](#1-deploy-envio-indexer)
2. 📊 [Create monitoring dashboard](https://github.com/susumutomita/ZeroKeyCI/tree/main/examples/envio-dashboard)
3. 🔔 [Set up notifications](https://github.com/susumutomita/ZeroKeyCI/tree/main/examples/envio-notifications)
4. 📈 [Build analytics](https://github.com/susumutomita/ZeroKeyCI/tree/main/examples/envio-analytics)

## Resources

- [Envio Documentation](https://docs.envio.dev)
- [HyperSync API](https://docs.envio.dev/hypersync)
- [GraphQL Schema Reference](/.zerokey/envio-schema.graphql)
- [Event Handlers Source](/src/envio/EventHandlers.ts)
- [Query Examples](/src/envio/queries.graphql)

---

**Questions?** Check our [FAQ](/docs/HOW_IT_WORKS.md#faq) or open a [discussion](https://github.com/susumutomita/ZeroKeyCI/discussions).
